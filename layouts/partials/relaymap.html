<% if @item[:map] %>
<style>
  #map {
    width:  100%;
    height: 500px;
  }
</style>

<div id="map"></div>

<script>
<% if !@item[:gps_center] %>
d3.json('<%= @item[:map] %>',
  function(error, topology) {
    var center = d3.geo.centroid(topology);
    var bounds = d3.geo.bounds(topology);

    var p = d3.select("#map").append("p");
    p.append("b").text("Please add the following to the config:");

    p.append("code").append("pre").text("gps_center: lat:"+center[1].toFixed(3)
                +", lng:"+center[0].toFixed(3)+"\n"

                +"gps_sw: "+bounds[0][1].toFixed(3)
                +","+bounds[0][0].toFixed(3)+"\n"

                +"gps_ne: "+bounds[1][1].toFixed(3)
                +","+bounds[1][0].toFixed(3));
  }
);

<% else %>

var map = new google.maps.Map(d3.select("#map").node(),
                  {zoom: 7,
                   center: {<%= @item[:gps_center] %>}});
// add the data
map.data.loadGeoJson('<%= @item[:map] %>');

// set the boundaries
var southWest = new google.maps.LatLng(<%= @item[:gps_sw] %>);
var northEast = new google.maps.LatLng(<%= @item[:gps_ne] %>);
var bounds = new google.maps.LatLngBounds(southWest,northEast);
map.fitBounds(bounds);

// add listeners
map.data.addListener('click', function(event) {
var url = event.latLng.toUrlValue();
  if ( /(iPad|iPhone|iPod)/g.test( navigator.userAgent ) ) { // |iPhone|iPod don't work
    url = "https://maps.apple.com/?q=" + url;
    window.location = url;
  }
  else
  {
    url = "https://www.google.com/maps/place/" + url;
    window.open(url);
  }
});
map.data.addListener('mouseover', function(event) {
  //console.log(event);
  //console.log(event.feature.j);
  //console.log("http://maps.apple.com/?ll=" +event.latLng.toUrlValue());
});
map.data.addListener('mouseout', function(event) {
  map.data.revertStyle();
});

// Origins, anchor positions and coordinates of the marker
// increase in the X direction to the right and in
// the Y direction down.
//var image = {
//  url: 'images/beachflag.png',
  // This marker is 20 pixels wide by 32 pixels tall.
//  size: new google.maps.Size(20, 32),
  // The origin for this image is 0,0.
//  origin: new google.maps.Point(0,0),
  // The anchor for this image is the base of the flagpole at 0,32.
//  anchor: new google.maps.Point(0, 32)
//};

// set up the markers and titles
map.data.setStyle(function(feature) {
  //console.log(feature);
  // also should return the icon
  return {title: "Leg "+feature.getProperty('leg')
                 +": "+feature.getProperty("miles")+" miles"};
});
<% end %>
</script>

<% end %>
